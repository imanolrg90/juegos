<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Impostor TV</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { 
            background: #1a1a2e; 
            color: white; 
            font-family: 'Poppins', sans-serif; 
            text-align: center; 
            margin: 0; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            overflow: hidden; 
        }
        
        /* Lobby */
        #qr-container { background: white; padding: 20px; border-radius: 20px; margin-top: 20px; display: inline-block; }
        .join-url { font-size: 1.5rem; color: #667eea; margin-top: 10px; font-weight: bold; }
        
        /* Grid Jugadores */
        .players-grid { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; width: 90%; margin-top: 40px; }
        
        .tv-card { 
            background: rgba(255,255,255,0.1); 
            border: 2px solid rgba(255,255,255,0.2); 
            border-radius: 20px; 
            padding: 20px; 
            width: 140px; 
            position: relative; /* Importante para posicionar elementos absolutos dentro */
            transition: all 0.5s;
        }
        .tv-card.eliminated { background: #333; opacity: 0.5; filter: grayscale(1); border-color: #555; }
        .tv-icon { font-size: 4rem; display: block; }
        .tv-name { font-size: 1.2rem; font-weight: bold; margin-top: 10px; display: block; }
        
        /* Votaciones (Esquina Superior IZQUIERDA) */
        .vote-badge {
            position: absolute; 
            top: -10px; 
            left: -10px; /* Izquierda para no pisar la X */
            background: #ff4b2b; 
            color: white;
            width: 40px; 
            height: 40px; 
            border-radius: 50%; 
            font-size: 1.5rem; 
            font-weight: bold;
            display: flex; 
            align-items: center; 
            justify-content: center;
            box-shadow: 2px 2px 10px rgba(0,0,0,0.5); 
            border: 2px solid white;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 5;
        }

        /* Bot√≥n Expulsar (Esquina Superior DERECHA) */
        .btn-kick {
            position: absolute;
            top: -10px;
            right: -10px; /* Derecha */
            background: #ef4444; 
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-weight: bold;
            cursor: pointer;
            z-index: 10;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .btn-kick:hover { transform: scale(1.1); background: #dc2626; }

        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* Botones TV */
        .btn-start-tv {
            margin-top: 30px; padding: 15px 40px; font-size: 2rem; border-radius: 50px;
            background: linear-gradient(45deg, #ff4b2b, #ff416c); color: white; border: none;
            cursor: pointer; box-shadow: 0 10px 30px rgba(255, 75, 43, 0.4); font-weight: 800;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>

    <div id="viewLobby">
        <h1 style="font-size: 3rem; margin:0;">üïµÔ∏è‚Äç‚ôÄÔ∏è √önete a la partida</h1>
        
        <div id="qr-container">
            <div id="qrcode"></div>
        </div>
        <div id="urlDisplay" class="join-url"></div>
        
        <div id="lobbyList" class="players-grid"></div>
        
        <div style="margin-top: 20px;">
            <label style="font-size: 1.2rem;">Impostores: </label>
            <select id="tvImpostorCount" style="font-size: 1.2rem; padding: 5px;">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
            </select>
        </div>
        <button class="btn-start-tv" onclick="startGame()">EMPEZAR JUEGO</button>
    </div>

    <div id="viewGame" style="display:none; width: 100%;">
        <h1 id="themeDisplay" style="font-size: 2.5rem; color:#ffd700;">TEM√ÅTICA</h1>
        
        <h2 id="starterDisplay" style="color: #4cd137; margin: 0 0 20px 0; font-size: 1.8rem;"></h2>

        <h2 id="phaseDisplay" style="color: #aaa;">Estado</h2>
        <div id="gameList" class="players-grid"></div>
        
        <button id="resolveBtn" class="btn-start-tv" style="display:none; background: #667eea;" onclick="resolveVotes()">VER QUI√âN SE VA</button>
        <button id="startVoteBtn" class="btn-start-tv" style="display:none;" onclick="openVoting()">ABRIR VOTACI√ìN</button>
    </div>

    <div id="viewResult" style="display:none;">
        <div id="winIcon" style="font-size: 8rem;">üèÜ</div>
        <h1 id="winTitle" style="font-size: 4rem; margin: 10px 0;">VICTORIA</h1>
        <h2 id="winDetails" style="font-size: 2rem; color: #aaa;"></h2>
        <button class="btn-start-tv" onclick="resetGame()">NUEVA PARTIDA</button>
    </div>

    <script>
        // --- CONFIGURACI√ìN ---
        // Cambia esto por tu IP local si usas m√≥viles en la misma red
        // Ejemplo: "http://192.168.1.35:5002/impostor/impostor-control.html"
        const CONTROL_URL = window.location.origin + "/impostor/impostor-control.html";
        
        let qrGenerated = false;
        
        // Generar QR al cargar
        window.onload = function() {
            document.getElementById('urlDisplay').textContent = CONTROL_URL;
            new QRCode(document.getElementById("qrcode"), {
                text: CONTROL_URL,
                width: 200,
                height: 200
            });
            qrGenerated = true;
        };

        // Polling cada segundo
        setInterval(refreshState, 1000);

        async function refreshState() {
            try {
                const res = await fetch('/api/tv/state');
                const state = await res.json();
                renderTV(state);
            } catch (e) {
                console.error("Conexi√≥n perdida con el servidor", e);
            }
        }

        // --- RENDERIZADO PRINCIPAL ---
        function renderTV(state) {
            const lobby = document.getElementById('viewLobby');
            const game = document.getElementById('viewGame');
            const result = document.getElementById('viewResult');

            // 1. Ocultar todo
            lobby.style.display = 'none';
            game.style.display = 'none';
            result.style.display = 'none';

            if (state.phase === 'lobby') {
                // --- LOBBY ---
                lobby.style.display = 'flex';
                lobby.style.flexDirection = 'column';
                // En lobby: NO votos, S√ç expulsar
                renderPlayers(state.players, 'lobbyList', false, true);
            
            } else if (state.phase === 'result') {
                // --- RESULTADO ---
                result.style.display = 'flex';
                result.style.flexDirection = 'column';
                const isCrew = state.winner === 'crew';
                
                const winTitle = document.getElementById('winTitle');
                winTitle.innerText = isCrew ? "¬°TRIPULANTES GANAN!" : "¬°IMPOSTORES GANAN!";
                winTitle.style.color = isCrew ? "#4cd137" : "#ff4b2b";
                document.getElementById('winIcon').innerText = isCrew ? "üëÆ‚Äç‚ôÇÔ∏è" : "üòà";

            } else {
                // --- JUEGO O VOTACI√ìN ---
                game.style.display = 'flex';
                game.style.flexDirection = 'column';
                
                // Tema
                document.getElementById('themeDisplay').innerText = `TEMA: ${state.theme}`;
                
                // Qui√©n empieza (Solo visible si estamos jugando, NO votando)
                const starterEl = document.getElementById('starterDisplay');
                if (state.phase === 'playing' && state.starting_player) {
                    starterEl.innerText = `üëâ Empieza: ${state.starting_player}`;
                    starterEl.style.display = 'block';
                } else {
                    starterEl.style.display = 'none';
                }

                // Estado texto
                const isVoting = state.phase === 'voting';
                document.getElementById('phaseDisplay').innerText = isVoting 
                    ? "üö® ¬°VOTACI√ìN AN√ìNIMA EN CURSO! üö®" 
                    : "Debatid y descubrid al mentiroso";
                
                // Botones admin
                document.getElementById('startVoteBtn').style.display = (!isVoting) ? 'inline-block' : 'none';
                document.getElementById('resolveBtn').style.display = isVoting ? 'inline-block' : 'none';

                // Jugadores: En juego mostramos votos si aplica, pero NO permitimos expulsar
                renderPlayers(state.players, 'gameList', isVoting, false);
            }
        }

        // --- RENDERIZADO JUGADORES ---
        function renderPlayers(players, containerId, showVotes, allowKick) {
            const container = document.getElementById(containerId);
            // Optimizacion simple: Si el numero de hijos es igual, asumimos que no hay cambios dr√°sticos 
            // para evitar parpadeos, aunque lo ideal es diffing real. Por ahora reconstruimos.
            container.innerHTML = '';
            
            players.forEach(p => {
                const div = document.createElement('div');
                div.className = `tv-card ${p.is_dead ? 'eliminated' : ''}`;
                
                // Burbuja Votos (Izquierda)
                let voteHTML = '';
                if (showVotes && p.votes > 0) {
                    voteHTML = `<div class="vote-badge">${p.votes}</div>`;
                }

                // Bot√≥n Kick (Derecha) - Solo si allowKick es true
                let kickButtonHTML = '';
                if (allowKick) {
                    // Pasamos 'event' para stopPropagation
                    kickButtonHTML = `<button class="btn-kick" onclick="kickPlayer(event, '${p.name}')">√ó</button>`;
                }

                div.innerHTML = `
                    ${kickButtonHTML}
                    ${voteHTML}
                    <span class="tv-icon">${p.icon}</span>
                    <span class="tv-name">${p.name}</span>
                `;
                container.appendChild(div);
            });
        }

        // --- ACCIONES AL SERVIDOR ---

        async function startGame() {
            const count = document.getElementById('tvImpostorCount').value;
            await fetch('/api/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ impostorCount: count })
            });
        }

        async function openVoting() {
            await fetch('/api/vote/start', { method: 'POST' });
        }

        async function resolveVotes() {
            const res = await fetch('/api/vote/resolve', { method: 'POST' });
            const data = await res.json();
            // La UI se actualiza sola con el polling
        }

        async function resetGame() {
            await fetch('/api/reset', { method: 'POST' });
        }

        async function kickPlayer(event, name) {
            event.stopPropagation(); // Evita clicks fantasma
            if(!confirm(`¬øSeguro que quieres echar a ${name}?`)) return;

            try {
                const res = await fetch('/api/kick', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ name: name })
                });
                if(!res.ok) alert("No se puede expulsar ahora (partida iniciada)");
            } catch (e) {
                console.error("Error al expulsar", e);
            }
        }
    </script>
</body>
</html>