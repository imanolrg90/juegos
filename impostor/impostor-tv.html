<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Impostor TV</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { background: #1a1a2e; color: white; font-family: 'Poppins', sans-serif; text-align: center; margin: 0; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; overflow: hidden; }
        
        /* Lobby */
        #qr-container { background: white; padding: 20px; border-radius: 20px; margin-top: 20px; display: inline-block; }
        .join-url { font-size: 1.5rem; color: #667eea; margin-top: 10px; font-weight: bold; }
        
        /* Grid Jugadores */
        .players-grid { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; width: 90%; margin-top: 40px; }
        .tv-card { 
            background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); 
            border-radius: 20px; padding: 20px; width: 140px; position: relative;
            transition: all 0.5s;
        }
        .tv-card.eliminated { background: #333; opacity: 0.5; filter: grayscale(1); border-color: #555; }
        .tv-icon { font-size: 4rem; display: block; }
        .tv-name { font-size: 1.2rem; font-weight: bold; margin-top: 10px; display: block; }
        
        /* Votaciones */
        .vote-badge {
            position: absolute; top: -10px; right: -10px; background: #ff4b2b; color: white;
            width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5); border: 2px solid white;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0); } to { transform: scale(1); } }

        /* Botones TV */
        .btn-start-tv {
            margin-top: 30px; padding: 15px 40px; font-size: 2rem; border-radius: 50px;
            background: linear-gradient(45deg, #ff4b2b, #ff416c); color: white; border: none;
            cursor: pointer; box-shadow: 0 10px 30px rgba(255, 75, 43, 0.4); font-weight: 800;
            animation: pulse 2s infinite;
        }
    </style>
</head>
<body>

    <div id="viewLobby">
        <h1 style="font-size: 3rem; margin:0;">üïµÔ∏è‚Äç‚ôÄÔ∏è √önete a la partida</h1>
        
        <div id="qr-container">
            <div id="qrcode"></div>
        </div>
        <div id="urlDisplay" class="join-url"></div>
        
        <div id="lobbyList" class="players-grid"></div>
        
        <div style="margin-top: 20px;">
            <label style="font-size: 1.2rem;">Impostores: </label>
            <select id="tvImpostorCount" style="font-size: 1.2rem; padding: 5px;">
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
            </select>
        </div>
        <button class="btn-start-tv" onclick="startGame()">EMPEZAR JUEGO</button>
    </div>

    <div id="viewGame" style="display:none; width: 100%;">
        <h1 id="themeDisplay" style="font-size: 2.5rem; color:#ffd700;">TEM√ÅTICA</h1>
        <h2 id="phaseDisplay" style="color: #aaa;">Estado</h2>
        <div id="gameList" class="players-grid"></div>
        
        <button id="resolveBtn" class="btn-start-tv" style="display:none; background: #667eea;" onclick="resolveVotes()">VER QUI√âN SE VA</button>
        <button id="startVoteBtn" class="btn-start-tv" style="display:none;" onclick="openVoting()">ABRIR VOTACI√ìN</button>
    </div>

    <div id="viewResult" style="display:none;">
        <div id="winIcon" style="font-size: 8rem;">üèÜ</div>
        <h1 id="winTitle" style="font-size: 4rem; margin: 10px 0;">VICTORIA</h1>
        <h2 id="winDetails" style="font-size: 2rem; color: #aaa;"></h2>
        <button class="btn-start-tv" onclick="resetGame()">NUEVA PARTIDA</button>
    </div>

    <script>
        // --- CONFIGURACI√ìN URL FIJA ---
        // El QR apuntar√° a la p√°gina de control en tu dominio
        const CONTROL_URL = "https://juegos.galanro.com/impostor/impostor-control.html";
        
        let qrGenerated = false;
        
        // Generar QR al cargar la p√°gina inmediatamente
        window.onload = function() {
            document.getElementById('urlDisplay').textContent = "Escanea para jugar";
            new QRCode(document.getElementById("qrcode"), {
                text: CONTROL_URL,
                width: 200,
                height: 200
            });
            qrGenerated = true;
        };

        // L√≥gica de actualizaci√≥n (Polling)
        setInterval(refreshState, 1000);

        async function refreshState() {
            try {
                const res = await fetch('/api/tv/state');
                const state = await res.json();
                renderTV(state);
            } catch (e) {
                console.error("Conexi√≥n perdida con el servidor", e);
            }
        }

        function renderTV(state) {
            const lobby = document.getElementById('viewLobby');
            const game = document.getElementById('viewGame');
            const result = document.getElementById('viewResult');

            // Reset vistas
            lobby.style.display = 'none';
            game.style.display = 'none';
            result.style.display = 'none';

            if (state.phase === 'lobby') {
                lobby.style.display = 'flex';
                lobby.style.flexDirection = 'column';
                renderPlayers(state.players, 'lobbyList', false);
            
            } else if (state.phase === 'result') {
                result.style.display = 'flex';
                result.style.flexDirection = 'column';
                const isCrew = state.winner === 'crew';
                document.getElementById('winTitle').innerText = isCrew ? "¬°TRIPULANTES GANAN!" : "¬°IMPOSTORES GANAN!";
                document.getElementById('winTitle').style.color = isCrew ? "#4cd137" : "#ff4b2b";
                document.getElementById('winIcon').innerText = isCrew ? "üëÆ‚Äç‚ôÇÔ∏è" : "üòà";

            } else {
                // PLAYING o VOTING
                game.style.display = 'flex';
                game.style.flexDirection = 'column';
                document.getElementById('themeDisplay').innerText = `TEMA: ${state.theme}`;
                
                const isVoting = state.phase === 'voting';
                document.getElementById('phaseDisplay').innerText = isVoting ? "üö® ¬°VOTACI√ìN AN√ìNIMA EN CURSO! üö®" : "Debatid y descubrid al mentiroso";
                
                document.getElementById('startVoteBtn').style.display = (!isVoting) ? 'inline-block' : 'none';
                document.getElementById('resolveBtn').style.display = isVoting ? 'inline-block' : 'none';

                renderPlayers(state.players, 'gameList', isVoting);
            }
        }

        function renderPlayers(players, containerId, showVotes) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            players.forEach(p => {
                const div = document.createElement('div');
                div.className = `tv-card ${p.is_dead ? 'eliminated' : ''}`;
                
                let voteHTML = '';
                if (showVotes && p.votes > 0) {
                    voteHTML = `<div class="vote-badge">${p.votes}</div>`;
                }

                div.innerHTML = `
                    ${voteHTML}
                    <span class="tv-icon">${p.icon}</span>
                    <span class="tv-name">${p.name}</span>
                `;
                container.appendChild(div);
            });
        }

        // --- ACCIONES TV ---
        async function startGame() {
            const count = document.getElementById('tvImpostorCount').value;
            await fetch('/api/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ impostorCount: count })
            });
        }

        async function openVoting() {
            await fetch('/api/vote/start', { method: 'POST' });
        }

        async function resolveVotes() {
            const res = await fetch('/api/vote/resolve', { method: 'POST' });
            const data = await res.json();
            if (data.eliminated) {
                // Peque√±a pausa dram√°tica o alerta
            } else if (!data.winner) {
                // Empate
            }
        }

        async function resetGame() {
            await fetch('/api/reset', { method: 'POST' });
        }
    </script>
</body>
</html>